<% if (request.referrer.match("/search") rescue false)
    session['list_url'] = '/search'
   else
     session['list_url'] = request.path
   end
%>


<style>
    .even, .odd{
        background: white !important;
    }
    .t-data{
        border: 1px dotted #d3d3d3;
        background: white;
    }
    th{
        background-color: lightsteelblue !important;
        color: black;
        padding: 10px !important;
    }
    #birth_type, #example_filter{
        margin-left: 15px;
        float: right;
        background:white;
    }

    #example_filter input{
        margin-bottom: 10px;
        font-size: 20px;
        padding: 5px;
        float: right;
        width: 250px;
        margin-left: 20px;
        margin-right: 30px;
    }

    #example_filter label{
        float: right;
    }
    .action-button{
        width: 70px !important;
        border-bottom: 1px solid ghostwhite !important;
    }

    .action-button div{
        margin: 2px !important;
        border-left: 1px solid #d3d3d3;
    }

    .action-button:hover, .action-button div:hover,
    .action-button:active, .action-button div:active,
    .white:hover, .white:active{
        background: white !important;
    }

     .paginate_button{
         font-size: 17px;
         font-weight: bold;
         padding: 13px !important;
         padding-left: 16px !important;
         padding-right: 16px !important;
     }


</style>
<div class='data-table-container'>

<table id="example" class="display" cellspacing="0" width="100%">
  <thead>
    <tr>
      <% if (@display_ben rescue false) %>
        <th style="text-align: left;">BEN</th>
      <% end %>
      <th style="text-align: left;min-width:15%;">Name</th>
      <th style="text-align: left;min-width:10%;">Birthdate</th>
      <th style="text-align: left;min-width:16%;">Mother's Details</th>
      <th style="text-align: left; min-width:16%;">Father's Details</th>
      <th style="text-align: center; min-width:16%;">Reporting Date</th>
      <th style="text-align: center;min-width: 10%;">Status</th>
      <th  style="text-align: left;min-width:14%;">&nbsp;</th>
    </tr>
  </thead>

  <tbody>


  <% display = SETTINGS['enable_role_privileges'] == false ? '' : 'none'
  %>

  <%(@records || []).each do |record|%>
      <tr>
        <% if (@display_ben rescue false) %>
            <td class='t-data' style="text-align: left;"><%= record['ben'] %></td>
        <% end %>
        <td class='t-data' style="text-align: left;"><%= record['name'] %></td>
        <td class='t-data' style="text-align: left;"><%= record['mother_name'] %></td>
        <td class='t-data' style="text-align: left;"><%= record['father_name'] %></td>
        <td class='t-data' style="text-align: center;"><%= record['date_of_reporting'] %></td>
        <td class='t-data' style="text-align: center;"><%=  record['status']%></td>
        <td class='t-data t-actions' style="background-color: white;">


          <table class='action-buttons' style="width: 100%; text-align: center; border-style: none;" cellpadding="0">
            <tr>
              <td class="action-button" onmousedown="window.location = '/person/<%= record['id']%>?next_path=<%= request.path%>'">
                <div url='/person/<%= record['id']%>?next_path=<%= request.path%>' class="btn btn-info"
                     >
                <%= image_tag "view.png", class: 'btn-images' %></div>
              </td>
              <td class="Edit_Record" onmousedown="window.location = '/person/<%= record['id']%>/edit?next_path=<%= request.path%>'"
                  style="display:<%= display%>;"
                  class="action-button">
                <div url='/person/<%= record['id']%>/edit?next_path=<%= request.path%>' class="btn btn-warning"
                        >
                <%= image_tag "edit.png", class: 'btn-images' %></div>
              </td>
              <td class="Void_Record"
                  style="display:<%= display%>;"
                  class="action-button">
                <div class="btn btn-success" onmousedown="javascript:alert();">
                <%= image_tag "void.png", class: 'btn-images' %></div>
              </td>
            </tr>
          </table>
      </tr>
    <%end%>
  </tbody>
</table>

</div>
<select id="birth_type" label="Birth Type" onchange="reloadDataTable(this)" style="width: 200px !important;
        padding: 5px; margin-right: 20px; font-size: 20px;"
        >
  <option value="All">Select Category</option>
  <option>From NID</option>
  <option>Normal</option>
  <option>Abandoned</option>
  <option>Adopted</option>
  <option>Orphaned</option>
</select>
<script>

<%
  (@actions || []).each do |action|
  next if (SETTINGS['enable_role_privileges'] == false)
%>
    var clas = "<%= action['button_name'].gsub(/\s+/, '_') %>";
    $("." + clas).show();

<% end %>

var table ;

$(document).ready(function() {
    initTable();

    var holder = __$('example_filter');
    holder.appendChild(__$('birth_type'));

    var search =__$('example_filter').getElementsByTagName("input")[0];
    search.setAttribute("onclick","changeFocusToMe(this)");
    searchData(search)

} );

search_value = '';
var ctrl;

function searchData(element) {
    if (element.value == 0 || search_value == element.value) {
        setTimeout(function () {
            searchData(element);
        }, 100)
    } else {
        search_value = element.value
        table.search(search_value).draw();
        setTimeout(function () {
            searchData(element);
        }, 100)
    }
}


var url = "/person/paginated_data";
<% display = SETTINGS['enable_role_privileges'] == false ? '' : 'none'

  %>
function initTable(){
    table =  $('#example').DataTable(
            {
                "processing": true,
                "serverSide": true,
                'pageLength': 5,
                "ordering": false,
                "ajax": {
                    "url": url,
                    "data": function(d){
                        d.type = __$('birth_type').value;
                        d.statuses = "<%= @states.join(',')%>",
                        d.assign_ben = "<%= (@display_ben rescue false) ? true : false %>"
                    },
                    dataFilter: function(data){
                        var json = jQuery.parseJSON( data );
                        for(var i = 0; i < json['data'].length; i ++){
                            var last_index = json['data'][i].length - 1;
                            var person_id = json['data'][i][last_index];
                            json['data'][i][last_index] = "<table><tr class='white'>"
                            json['data'][i][last_index] +=
                                    '<td class="action-button"> ' +
                                        '<div onclick="javascript:location=\'/person/' + person_id + '?next_path=<%= request.path%> \'"     ' +
                                            'url=\'/person/' + person_id + '?next_path=<%= request.path%> \'"     ' +
                                            '    class="action-btn btn btn-success btn-xs">' +
                                            '<%= image_tag "view.png", class: 'btn-images' %></div>' +
                                    '</td>';

                            json['data'][i][last_index] +=
                                    '<td class="Edit_Record action-button"> ' +
                                    '<div onclick="javascript:location=\'/person/' + person_id + '/edit?next_path=<%= request.path%> \'"     ' +
                                    'url=\'/person/' + person_id + '/edit?next_path=<%= request.path%> \'"     ' +
                                    '    class="action-btn btn btn-success btn-xs">' +
                                    '<%= image_tag "edit.png", class: 'btn-images' %></div>' +
                                    '</td>';


                            json['data'][i][last_index] += "</tr></table>"
                        }
                        return JSON.stringify( json );
                    }
                }}
    );
}

function reloadDataTable(node){
    table.ajax.reload();
}

function changeFocusToMe(control){

    if(control) {
        ctrl = control;
        if(__$("cursor_for_" + control.id)){
            if(__$("cursor")){
                    __$("cursor_for_" + control.id).appendChild(__$("cursor"));

                }
        }
        showKeyboard(control)
    }
}

</script>
